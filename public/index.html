<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Trading Agent Dashboard V4</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial;
  background:#0f172a;
  color:#e5e7eb;
  padding:20px;
}
.card {
  background:#020617;
  padding:16px;
  margin:12px 0;
  border-radius:12px;
}
.grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap:12px;
}
.metric { font-size:14px; opacity:.8 }
.value { font-size:20px; font-weight:bold }
table { width:100%; border-collapse:collapse }
td,th { padding:6px; border-bottom:1px solid #1f2937 }
canvas { background:#020617; padding:10px; border-radius:12px }
</style>
</head>

<body>

<h1>ðŸš€ Trading Agent Dashboard</h1>

<div id="metrics" class="grid"></div>

<div class="card">
<h2>ðŸ“ˆ Live Equity Curves</h2>
<canvas id="liveChart"></canvas>
</div>

<div class="card">
<h2>ðŸ“‰ Backtest Equity (60d)</h2>
<canvas id="btChart"></canvas>
</div>

<div class="card">
<h2>ðŸŽ¯ Today Signals</h2>
<div id="signals"></div>
</div>

<script>
const DATA_URL = "dashboard_data.json";
const BACKTEST_URL = "backtest_60d_results.json";

const COLORS = {
 A:"#38bdf8",
 B:"#f472b6",
 V:"#fb923c",
 M:"#34d399"
};

// Load JSON file with cache-busting
async function loadJSON(url){
  const r = await fetch(url + "?t=" + Date.now());
  if(!r.ok) throw new Error(url+" not found");
  return await r.json();
}

// Render metrics
function renderMetrics(strategies){
  const root = document.getElementById("metrics");
  root.innerHTML = "";

  Object.entries(strategies).forEach(([k,s])=>{
    if(!s.metrics) return;
    const m = s.metrics;

    root.innerHTML += `
      <div class="card">
        <div class="value">${s.name}</div>
        <div class="metric">Profit: $${m.total_profit}</div>
        <div class="metric">Return: ${m.total_return_pct.toFixed(2)}%</div>
        <div class="metric">Sharpe: ${m.sharpe_ratio.toFixed(2)}</div>
        <div class="metric">WinRate: ${m.win_rate.toFixed(1)}%</div>
        <div class="metric">Trades: ${m.num_trades}</div>
        <div class="metric">MaxDD: ${m.max_drawdown_pct.toFixed(2)}%</div>
      </div>
    `;
  });
}

// Render today's signals
function renderSignals(signals){
  let html="";

  Object.entries(signals).forEach(([mode,list])=>{
    if(!list || !list.length) return;

    html += `<h3>${mode}</h3><table>`;
    html += "<tr><th>Ticker</th><th>Side</th><th>SL</th><th>Score</th></tr>";

    list.forEach(s=>{
      html += `<tr>
        <td>${s.ticker}</td>
        <td>${s.action}</td>
        <td>${s.sl_factor}</td>
        <td>${s.z_score ?? s.prev_return_pct ?? ""}</td>
      </tr>`;
    });

    html += "</table>";
  });

  document.getElementById("signals").innerHTML = html;
}

// Render live equity curves
function renderLiveEquity(equity){
  const datasets = [];

  Object.entries(equity).forEach(([k,arr])=>{
    if(!arr || !arr.length) return;

    const data = arr.map((p,i)=>({
      x:i,
      y:(typeof p === "object") ? p.equity : p
    }));

    datasets.push({
      label:"Live "+k,
      data,
      borderColor: COLORS[k],
      tension: 0.2
    });
  });

  const ctx = document.getElementById("liveChart").getContext("2d");
  new Chart(ctx,{
    type:"line",
    data:{datasets},
    options:{parsing:false, scales:{x:{display:false}, y:{beginAtZero:false}}}
  });
}

// Render backtest 60d
function renderBacktest(bt){
  const datasets=[];

  Object.entries(bt).forEach(([k,s])=>{
    if(!s || !s.equity_curve) return;

    const data = s.equity_curve.map((v,i)=>({x:i,y:v}));

    datasets.push({
      label:"Backtest "+k,
      data,
      borderDash:[6,6],
      borderColor: COLORS[k],
      tension: 0.2
    });
  });

  const ctx = document.getElementById("btChart").getContext("2d");
  new Chart(ctx,{
    type:"line",
    data:{datasets},
    options:{parsing:false, scales:{x:{display:false}, y:{beginAtZero:false}}}
  });
}

// Main function
async function main(){
  try{
    const data = await loadJSON(DATA_URL);
    const bt   = await loadJSON(BACKTEST_URL);

    console.log("Dashboard data:", data);
    console.log("Backtest data:", bt);

    renderMetrics(data.strategies);
    renderSignals(data.signals);
    renderLiveEquity(data.equity);
    renderBacktest(bt);

    console.log("Dashboard loaded");
  }catch(e){
    document.body.innerHTML += "<h2>ERROR: "+e.message+"</h2>";
    console.error(e);
  }
}

main();
</script>
</body>
</html>
