<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Trading Backtest Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#111;
  color:#eee;
  padding:20px;
  margin:0;
}

.card {
  background:#1b1b1b;
  padding:20px;
  margin-bottom:25px;
  border-radius:10px;
  overflow-x:auto;
}

table {
  width:100%;
  border-collapse: collapse;
  min-width: 400px;
}

th, td {
  border:1px solid #333;
  padding:6px;
  font-size:13px;
  text-align:center;
}

td.profit-positive { color: lime; }
td.profit-negative { color: red; }

canvas {
  background:white;
  border-radius:8px;
  width: 100% !important;
  height: auto !important;
}

.controls {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:20px;
  align-items:center;
}

label {
  font-size:14px;
}

input[type=number] {
  width: 60px;
}

@media screen and (max-width: 768px) {
  .controls {
    flex-direction: column;
    align-items: flex-start;
  }
  table {
    font-size: 12px;
  }
}
</style>
</head>

<body>

<h1>üìä Backtest Dashboard ‚Äî All Strategies</h1>

<div class="controls">
  <label>
    Strategy:
    <select id="strategySelect"></select>
  </label>
  <label>
    Last Days (Equity & Trades):
    <input type="number" id="lastDays" value="3" min="1" max="30">
  </label>
  <button id="updateBtn">Update Chart</button>
</div>

<div class="card">
  <canvas id="multiChart" height="150"></canvas>
</div>

<div id="stats"></div>

<script>
const BACKTEST_URL = "https://trading-agent-bot.pages.dev/backtest_60d_results.json";
const DASHBOARD_URL = "https://trading-agent-bot.pages.dev/dashboard_data.json";
const CSV_URL = "https://raw.githubusercontent.com/pollcerny-sudo/trading-agent-bot/main/final_backtest_results.csv";

let backtestData = {};
let dashboardData = {};
let csvData = [];
let chartInstance = null;

// ================= HELPER FUNCTIONS =================
function getTradePnl(t) {
  const candidates = [t.Profit,t.profit,t.pnl,t.pnl_pct,t.profit_pct,t.return,t.ret];
  for(let v of candidates){
    if(v!==undefined && v!==null && v!==""){
      let num = Number(v);
      if(!isNaN(num)) return (Math.abs(num)<2 ? (num*100).toFixed(2)+"%" : num.toFixed(2));
    }
  }
  return "-";
}

function renderTrades(trades){
  if(!trades || trades.length===0) return "No trades";
  let rows = trades.map(t=>{
    const pnlClass = Number(t.Profit || t.profit || t.pnl || 0)>=0 ? "profit-positive" : "profit-negative";
    return `
    <tr>
      <td>${t.Date||t.date||""}</td>
      <td>${t.Strategy||t.strategy||""}</td>
      <td>${t.Ticker||t.ticker||""}</td>
      <td>${t.Side||t.side||""}</td>
      <td class="${pnlClass}">${getTradePnl(t)}</td>
    </tr>`;
  }).join("");
  return `
  <table>
    <tr><th>Date</th><th>Strategy</th><th>Ticker</th><th>Side</th><th>PnL</th></tr>
    ${rows}
  </table>`;
}

function renderSignals(signals){
  if(!signals || signals.length===0) return "No signals";
  let rows = signals.map(s=>`
    <tr>
      <td>${s.ticker}</td>
      <td>${s.action}</td>
      <td>$${s.allocation_usd.toLocaleString()}</td>
      <td>${s.sl_factor}</td>
      <td>${s.prev_return_pct!==null?s.prev_return_pct.toFixed(2)+"%":"-"}</td>
    </tr>
  `).join("");
  return `
  <table>
    <tr><th>Ticker</th><th>Action</th><th>Allocation</th><th>SL Factor</th><th>Prev Return</th></tr>
    ${rows}
  </table>`;
}

// ================= CSV PARSING =================
async function loadCSV(){
  try{
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const lines = text.trim().split("\n");
    const header = lines[0].split(",");
    csvData = lines.slice(1).map(l=>{
      const cols = l.split(",");
      const obj = {};
      header.forEach((h,i)=> obj[h.trim()]=cols[i].trim());
      return obj;
    });
  }catch(e){
    console.error("CSV load error:", e);
  }
}

function renderCSVTrades(strategyKey, lastDays){
  if(csvData.length===0) return "CSV data not loaded";
  const filtered = csvData.filter(t=>t.Strategy===strategyKey);
  const grouped = {};
  filtered.forEach(t=>{
    if(!grouped[t.Date]) grouped[t.Date]=[];
    grouped[t.Date].push(t);
  });
  const dates = Object.keys(grouped).sort().slice(-lastDays).reverse();
  return dates.map(d=>{
    const dayProfit = grouped[d].reduce((a,b)=>a + Number(b.Profit||b.profit||b.pnl||0),0);
    return `
      <div class="card">
        <h3>CSV Trades ${d} ‚Äî Total Profit: $${dayProfit.toFixed(2)}</h3>
        ${renderTrades(grouped[d])}
      </div>
    `;
  }).join("");
}

// ================= BUILD DASHBOARD =================
function buildDashboard(strategyKey, lastDays){
  const statsDiv = document.getElementById("stats");
  statsDiv.innerHTML="";

  const datasets = [];
  const currEquityData = dashboardData.equity[strategyKey] || [];
  const currEq = currEquityData.slice(-lastDays);

  const labels = currEq.map(e=>e.date);
  const currValues = currEq.map(e=>e.equity);
  datasets.push({label:"Current Equity "+strategyKey,data:currValues,borderColor:'lime',borderWidth:2,fill:false});

  const currMetrics = dashboardData.strategies[strategyKey].metrics;
  const signals = dashboardData.signals[strategyKey] || [];

  statsDiv.innerHTML += `
    <div class="card">
      <h2>Current ${dashboardData.strategies[strategyKey].name} (${strategyKey})</h2>
      Total Profit: $${currMetrics.total_profit.toLocaleString()}<br>
      Total Return: ${(currMetrics.total_return_pct).toFixed(2)}%<br>
      Trades: ${currMetrics.num_trades} | Win Rate: ${(currMetrics.win_rate).toFixed(2)}%<br>
      Avg Win: $${currMetrics.avg_win.toFixed(2)} | Avg Loss: $${currMetrics.avg_loss.toFixed(2)}<br>
      Sharpe: ${currMetrics.sharpe_ratio.toFixed(2)} | Max DD: ${(currMetrics.max_drawdown_pct).toFixed(2)}% | PF: ${currMetrics.profit_factor.toFixed(2)}
      <h3>Current Signals</h3>
      ${renderSignals(signals)}
    </div>`;

  // --- Backtest Trades podle dn≈Ø ---
  if(backtestData[strategyKey] && backtestData[strategyKey].trades){
    const btTrades = backtestData[strategyKey].trades;
    const grouped = {};
    btTrades.forEach(t=>{
      const d = t.Date || t.date || t.entry_date || "Unknown";
      if(!grouped[d]) grouped[d]=[];
      grouped[d].push(t);
    });
    const dates = Object.keys(grouped).sort().slice(-lastDays).reverse();

    dates.forEach(d=>{
      const dayProfit = grouped[d].reduce((a,b)=>a + Number(b.Profit || b.profit || b.pnl || 0),0);
      statsDiv.innerHTML += `
        <div class="card">
          <h3>Backtest Trades ${d} ‚Äî Total Profit: $${dayProfit.toFixed(2)}</h3>
          ${renderTrades(grouped[d])}
        </div>`;
    });
  }

  // --- CSV Trades posledn√≠ch X dn√≠ ---
  statsDiv.innerHTML += renderCSVTrades(strategyKey, lastDays);

  // --- Current Equity vs Backtest ---
  if(backtestData[strategyKey] && backtestData[strategyKey].equity_curve){
    let eq_bt = backtestData[strategyKey].equity_curve.slice(-currEq.length);
    const lastCurr = currValues[currValues.length-1];
    const lastBt = eq_bt[eq_bt.length-1];
    const factor = lastCurr / lastBt;
    eq_bt = eq_bt.map(v=>v*factor);
    datasets.push({label:"Backtest "+strategyKey,data:eq_bt,borderColor:'cyan',borderWidth:2,fill:false});
  }

  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(document.getElementById("multiChart"),{
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:true}},
      scales:{x:{display:true},y:{display:true}}
    }
  });
}

// ================= LOAD DATA =================
async function loadData(){
  try{
    const [btRes,dashRes] = await Promise.all([fetch(BACKTEST_URL),fetch(DASHBOARD_URL)]);
    backtestData = await btRes.json();
    dashboardData = await dashRes.json();
    await loadCSV();

    const sel = document.getElementById("strategySelect");
    Object.keys(dashboardData.strategies).forEach(k=>{
      const opt = document.createElement("option"); opt.value=k; opt.text=k;
      sel.appendChild(opt);
    });

    buildDashboard(sel.value, Number(document.getElementById("lastDays").value));

  }catch(e){
    document.body.innerHTML += "<h2>‚ùå LOAD ERROR</h2><pre>"+e+"</pre>";
  }
}

document.getElementById("updateBtn").onclick = ()=>{
  const strat = document.getElementById("strategySelect").value;
  const days = Number(document.getElementById("lastDays").value);
  buildDashboard(strat,days);
}

loadData();
</script>
</body>
</html>
